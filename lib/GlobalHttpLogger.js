"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _http = _interopRequireDefault(require("http"));

var _https = _interopRequireDefault(require("https"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const matches = process.version.match(/^v(\d+)\.(\d+)\.(\d+)$/);
const nodeMajorVersion = matches ? +matches[1] : 0;

class ResponseBodyCollector {
  constructor(response) {
    _defineProperty(this, "buffers", void 0);

    _defineProperty(this, "bodyPromise", void 0);

    this.buffers = [];
    this.bodyPromise = new Promise((resolve, reject) => {
      response.prependListener('data', chunk => {
        this.buffers.push(chunk);
      });
      response.prependListener('end', () => {
        const body = Buffer.concat(this.buffers);
        resolve(body);
      });
    });
  }

  getBodyAsync() {
    return this.bodyPromise;
  }

}

const waitForResponseOrError = request => new Promise((resolve, reject) => {
  request.prependOnceListener('response', response => {
    const responseBodyCollector = new ResponseBodyCollector(response);
    resolve({
      response,
      responseBodyCollector
    });
  });
  request.prependOnceListener('error', error => {
    resolve({
      error
    });
  });
});

const collectRequestBody = request => new Promise((resolve, reject) => {
  const requestBody = [];
  const reqWrite = request.write;

  request.write = function (...args) {
    /**
     * chunk can be either a string or a Buffer.
     */
    const chunk = arguments[0];

    if (Buffer.isBuffer(chunk)) {
      requestBody.push(chunk);
    } else {
      requestBody.push(Buffer.from(chunk, 'utf8'));
    }

    return reqWrite.apply(this, args);
  };

  const reqEnd = request.end;

  request.end = function (...args) {
    /**
     * the first argument might be a callback or a chunk
     */
    const maybeChunk = arguments[0];

    if (Buffer.isBuffer(maybeChunk)) {
      requestBody.push(maybeChunk);
    } else if (maybeChunk && typeof maybeChunk !== 'function') {
      requestBody.push(Buffer.from(maybeChunk, 'utf8'));
    }

    return reqEnd.apply(this, args);
  };

  request.prependOnceListener('finish', () => {
    if (!requestBody.length) {
      resolve(null);
    } else {
      resolve(Buffer.concat(requestBody));
    }
  });
  request.prependOnceListener('error', () => resolve(null));
});

const interceptRequest = async (request, {
  onRequestEnd
}) => {
  const [requestBody, {
    response,
    responseBody,
    error
  }] = await Promise.all([collectRequestBody(request), (async () => {
    const {
      response,
      responseBodyCollector,
      error
    } = await waitForResponseOrError(request);

    if (response && responseBodyCollector) {
      return {
        response,
        responseBody: await responseBodyCollector.getBodyAsync(),
        error: null
      };
    } else if (error) {
      return {
        response: null,
        responseBody: null,
        error
      };
    } else {
      throw new Error('No responseBodyCollector');
    }
  })()]);
  const protocol = request.agent.protocol;
  const host = request.getHeader('host');
  const path = request.path;
  const loggerRequest = {
    url: `${protocol}//${host}${path}`,
    method: request.method,
    headers: request._headers,
    body: requestBody ? requestBody : null
  };

  if (response) {
    const loggerResponse = {
      status: response.statusCode,
      body: responseBody ? responseBody : null,
      headers: response.headers
    };
    onRequestEnd({
      request: loggerRequest,
      response: loggerResponse,
      error: null
    });
  } else if (error) {
    const loggerError = {
      message: error.message,
      code: error.code,
      stack: error.stack || ''
    };
    onRequestEnd({
      request: loggerRequest,
      response: null,
      error: loggerError
    });
  }
};

class GlobalHttpLogger {
  constructor({
    onRequestEnd
  }) {
    _defineProperty(this, "onRequestEnd", void 0);

    this.onRequestEnd = onRequestEnd;
  }

  start() {
    const {
      onRequestEnd
    } = this;

    const interceptedRequestMethod = (object, func, ...rest) => {
      const req = func.call(object, ...rest);
      interceptRequest(req, {
        onRequestEnd
      });
      return req;
    };

    _http.default.request = interceptedRequestMethod.bind(null, _http.default, _http.default.request);
    _http.default.get = interceptedRequestMethod.bind(null, _http.default, _http.default.get);
    /**
     * https.request proxies to http.request for 8.x and earlier versions
     */

    if (nodeMajorVersion > 8) {
      _https.default.get = interceptedRequestMethod.bind(null, _https.default, _https.default.get);
      _https.default.request = interceptedRequestMethod.bind(null, _https.default, _https.default.request);
    }
  }

  stop() {}

}

exports.default = GlobalHttpLogger;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9HbG9iYWxIdHRwTG9nZ2VyLnRzIl0sIm5hbWVzIjpbIm1hdGNoZXMiLCJwcm9jZXNzIiwidmVyc2lvbiIsIm1hdGNoIiwibm9kZU1ham9yVmVyc2lvbiIsIlJlc3BvbnNlQm9keUNvbGxlY3RvciIsImNvbnN0cnVjdG9yIiwicmVzcG9uc2UiLCJidWZmZXJzIiwiYm9keVByb21pc2UiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsInByZXBlbmRMaXN0ZW5lciIsImNodW5rIiwicHVzaCIsImJvZHkiLCJCdWZmZXIiLCJjb25jYXQiLCJnZXRCb2R5QXN5bmMiLCJ3YWl0Rm9yUmVzcG9uc2VPckVycm9yIiwicmVxdWVzdCIsInByZXBlbmRPbmNlTGlzdGVuZXIiLCJyZXNwb25zZUJvZHlDb2xsZWN0b3IiLCJlcnJvciIsImNvbGxlY3RSZXF1ZXN0Qm9keSIsInJlcXVlc3RCb2R5IiwicmVxV3JpdGUiLCJ3cml0ZSIsImFyZ3MiLCJhcmd1bWVudHMiLCJpc0J1ZmZlciIsImZyb20iLCJhcHBseSIsInJlcUVuZCIsImVuZCIsIm1heWJlQ2h1bmsiLCJsZW5ndGgiLCJpbnRlcmNlcHRSZXF1ZXN0Iiwib25SZXF1ZXN0RW5kIiwicmVzcG9uc2VCb2R5IiwiYWxsIiwiRXJyb3IiLCJwcm90b2NvbCIsImFnZW50IiwiaG9zdCIsImdldEhlYWRlciIsInBhdGgiLCJsb2dnZXJSZXF1ZXN0IiwidXJsIiwibWV0aG9kIiwiaGVhZGVycyIsIl9oZWFkZXJzIiwibG9nZ2VyUmVzcG9uc2UiLCJzdGF0dXMiLCJzdGF0dXNDb2RlIiwibG9nZ2VyRXJyb3IiLCJtZXNzYWdlIiwiY29kZSIsInN0YWNrIiwiR2xvYmFsSHR0cExvZ2dlciIsInN0YXJ0IiwiaW50ZXJjZXB0ZWRSZXF1ZXN0TWV0aG9kIiwib2JqZWN0IiwiZnVuYyIsInJlc3QiLCJyZXEiLCJjYWxsIiwiaHR0cCIsImJpbmQiLCJnZXQiLCJodHRwcyIsInN0b3AiXSwibWFwcGluZ3MiOiI7Ozs7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QUFDSCxLQVJEOztBQVVBRSxrQkFBSy9DLE9BQUwsR0FBZXlDLHdCQUF3QixDQUFDTyxJQUF6QixDQUE4QixJQUE5QixFQUFvQ0QsYUFBcEMsRUFBMENBLGNBQUsvQyxPQUEvQyxDQUFmO0FBQ0ErQyxrQkFBS0UsR0FBTCxHQUFXUix3QkFBd0IsQ0FBQ08sSUFBekIsQ0FBOEIsSUFBOUIsRUFBb0NELGFBQXBDLEVBQTBDQSxjQUFLRSxHQUEvQyxDQUFYO0FBRUE7Ozs7QUFHQSxRQUFJbEUsZ0JBQWdCLEdBQUcsQ0FBdkIsRUFBMEI7QUFDdEJtRSxxQkFBTUQsR0FBTixHQUFZUix3QkFBd0IsQ0FBQ08sSUFBekIsQ0FBOEIsSUFBOUIsRUFBb0NFLGNBQXBDLEVBQTJDQSxlQUFNRCxHQUFqRCxDQUFaO0FBQ0FDLHFCQUFNbEQsT0FBTixHQUFnQnlDLHdCQUF3QixDQUFDTyxJQUF6QixDQUNaLElBRFksRUFFWkUsY0FGWSxFQUdaQSxlQUFNbEQsT0FITSxDQUFoQjtBQUtIO0FBQ0o7O0FBQ0RtRCxFQUFBQSxJQUFJLEdBQUcsQ0FBRTs7QUFoQ3lCIiwic291cmNlc0NvbnRlbnQiOlsiLy8gaHR0cHM6Ly9naXRodWIuY29tL01pY3Jvc29mdC9UeXBlU2NyaXB0LUJhYmVsLVN0YXJ0ZXJcblxuaW1wb3J0IGh0dHAsIHsgQ2xpZW50UmVxdWVzdCwgU2VydmVyUmVzcG9uc2UgfSBmcm9tICdodHRwJztcbmltcG9ydCBodHRwcyBmcm9tICdodHRwcyc7XG5pbXBvcnQge1xuICAgIExvZ2dlck9uUmVzcG9uc2VQYXlsb2FkLFxuICAgIExvZ2dlckhlYWRlcnMsXG4gICAgTG9nZ2VyUmVxdWVzdCxcbiAgICBMb2dnZXJSZXNwb25zZSxcbiAgICBMb2dnZXJPblJlc3BvbnNlQ2FsbGJhY2tcbn0gZnJvbSAnLi9TaGFyZWRUeXBlcyc7XG5cbmNvbnN0IG1hdGNoZXMgPSBwcm9jZXNzLnZlcnNpb24ubWF0Y2goL152KFxcZCspXFwuKFxcZCspXFwuKFxcZCspJC8pO1xuY29uc3Qgbm9kZU1ham9yVmVyc2lvbiA9IG1hdGNoZXMgPyArbWF0Y2hlc1sxXSA6IDA7XG5cbmludGVyZmFjZSBDbGllbnRSZXF1ZXN0V2l0aFVuZG9jdW1lbnRlZE1lbWJlcnMgZXh0ZW5kcyBDbGllbnRSZXF1ZXN0IHtcbiAgICBhZ2VudDogYW55O1xuICAgIG1ldGhvZDogc3RyaW5nO1xuICAgIF9oZWFkZXJzOiB7IFtoZWFkZXJOYW1lOiBzdHJpbmddOiBzdHJpbmcgfTtcbn1cblxuaW50ZXJmYWNlIFNlcnZlclJlc3BvbnNlV2l0aFVuZG9jdW1lbnRlZE1lbWJlcnMgZXh0ZW5kcyBTZXJ2ZXJSZXNwb25zZSB7XG4gICAgaGVhZGVyczogeyBbaGVhZGVyTmFtZTogc3RyaW5nXTogc3RyaW5nIH07XG59XG5cbmNsYXNzIFJlc3BvbnNlQm9keUNvbGxlY3RvciB7XG4gICAgYnVmZmVyczogQXJyYXk8QnVmZmVyPjtcblxuICAgIGJvZHlQcm9taXNlOiBQcm9taXNlPEJ1ZmZlcj47XG5cbiAgICBjb25zdHJ1Y3RvcihyZXNwb25zZTogU2VydmVyUmVzcG9uc2UpIHtcbiAgICAgICAgdGhpcy5idWZmZXJzID0gW107XG4gICAgICAgIHRoaXMuYm9keVByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICByZXNwb25zZS5wcmVwZW5kTGlzdGVuZXIoJ2RhdGEnLCBjaHVuayA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5idWZmZXJzLnB1c2goY2h1bmspO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXNwb25zZS5wcmVwZW5kTGlzdGVuZXIoJ2VuZCcsICgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBib2R5ID0gQnVmZmVyLmNvbmNhdCh0aGlzLmJ1ZmZlcnMpO1xuICAgICAgICAgICAgICAgIHJlc29sdmUoYm9keSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0Qm9keUFzeW5jKCk6IFByb21pc2U8QnVmZmVyPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmJvZHlQcm9taXNlO1xuICAgIH1cbn1cblxuY29uc3Qgd2FpdEZvclJlc3BvbnNlT3JFcnJvciA9IChcbiAgICByZXF1ZXN0OiBDbGllbnRSZXF1ZXN0XG4pOiBQcm9taXNlPHtcbiAgICByZXNwb25zZT86IFNlcnZlclJlc3BvbnNlO1xuICAgIHJlc3BvbnNlQm9keUNvbGxlY3Rvcj86IFJlc3BvbnNlQm9keUNvbGxlY3RvcjtcbiAgICBlcnJvcj86IEVycm9yO1xufT4gPT5cbiAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIHJlcXVlc3QucHJlcGVuZE9uY2VMaXN0ZW5lcigncmVzcG9uc2UnLCByZXNwb25zZSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZXNwb25zZUJvZHlDb2xsZWN0b3IgPSBuZXcgUmVzcG9uc2VCb2R5Q29sbGVjdG9yKHJlc3BvbnNlKTtcbiAgICAgICAgICAgIHJlc29sdmUoeyByZXNwb25zZSwgcmVzcG9uc2VCb2R5Q29sbGVjdG9yIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgcmVxdWVzdC5wcmVwZW5kT25jZUxpc3RlbmVyKCdlcnJvcicsIGVycm9yID0+IHtcbiAgICAgICAgICAgIHJlc29sdmUoeyBlcnJvciB9KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG5cbmNvbnN0IGNvbGxlY3RSZXF1ZXN0Qm9keSA9IChyZXF1ZXN0OiBDbGllbnRSZXF1ZXN0KTogUHJvbWlzZTxCdWZmZXIgfCBudWxsPiA9PlxuICAgIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29uc3QgcmVxdWVzdEJvZHk6IEFycmF5PEJ1ZmZlcj4gPSBbXTtcblxuICAgICAgICBjb25zdCByZXFXcml0ZSA9IHJlcXVlc3Qud3JpdGU7XG4gICAgICAgIHJlcXVlc3Qud3JpdGUgPSBmdW5jdGlvbiguLi5hcmdzOiBhbnkpIHtcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogY2h1bmsgY2FuIGJlIGVpdGhlciBhIHN0cmluZyBvciBhIEJ1ZmZlci5cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgY29uc3QgY2h1bmsgPSBhcmd1bWVudHNbMF07XG5cbiAgICAgICAgICAgIGlmIChCdWZmZXIuaXNCdWZmZXIoY2h1bmspKSB7XG4gICAgICAgICAgICAgICAgcmVxdWVzdEJvZHkucHVzaChjaHVuayk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlcXVlc3RCb2R5LnB1c2goQnVmZmVyLmZyb20oY2h1bmssICd1dGY4JykpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcmVxV3JpdGUuYXBwbHkodGhpcywgYXJncyk7XG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgcmVxRW5kID0gcmVxdWVzdC5lbmQ7XG4gICAgICAgIHJlcXVlc3QuZW5kID0gZnVuY3Rpb24oLi4uYXJnczogYW55KSB7XG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIHRoZSBmaXJzdCBhcmd1bWVudCBtaWdodCBiZSBhIGNhbGxiYWNrIG9yIGEgY2h1bmtcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgY29uc3QgbWF5YmVDaHVuayA9IGFyZ3VtZW50c1swXTtcblxuICAgICAgICAgICAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihtYXliZUNodW5rKSkge1xuICAgICAgICAgICAgICAgIHJlcXVlc3RCb2R5LnB1c2gobWF5YmVDaHVuayk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKG1heWJlQ2h1bmsgJiYgdHlwZW9mIG1heWJlQ2h1bmsgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICByZXF1ZXN0Qm9keS5wdXNoKEJ1ZmZlci5mcm9tKG1heWJlQ2h1bmssICd1dGY4JykpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcmVxRW5kLmFwcGx5KHRoaXMsIGFyZ3MpO1xuICAgICAgICB9O1xuXG4gICAgICAgIHJlcXVlc3QucHJlcGVuZE9uY2VMaXN0ZW5lcignZmluaXNoJywgKCkgPT4ge1xuICAgICAgICAgICAgaWYgKCFyZXF1ZXN0Qm9keS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKG51bGwpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKEJ1ZmZlci5jb25jYXQocmVxdWVzdEJvZHkpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmVxdWVzdC5wcmVwZW5kT25jZUxpc3RlbmVyKCdlcnJvcicsICgpID0+IHJlc29sdmUobnVsbCkpO1xuICAgIH0pO1xuXG5jb25zdCBpbnRlcmNlcHRSZXF1ZXN0ID0gYXN5bmMgKFxuICAgIHJlcXVlc3Q6IENsaWVudFJlcXVlc3QsXG4gICAge1xuICAgICAgICBvblJlcXVlc3RFbmRcbiAgICB9OiB7IG9uUmVxdWVzdEVuZDogKHBheWxvYWQ6IExvZ2dlck9uUmVzcG9uc2VQYXlsb2FkKSA9PiB2b2lkIH1cbikgPT4ge1xuICAgIGNvbnN0IFtyZXF1ZXN0Qm9keSwgeyByZXNwb25zZSwgcmVzcG9uc2VCb2R5LCBlcnJvciB9XSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgY29sbGVjdFJlcXVlc3RCb2R5KHJlcXVlc3QpLFxuICAgICAgICAoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3Qge1xuICAgICAgICAgICAgICAgIHJlc3BvbnNlLFxuICAgICAgICAgICAgICAgIHJlc3BvbnNlQm9keUNvbGxlY3RvcixcbiAgICAgICAgICAgICAgICBlcnJvclxuICAgICAgICAgICAgfSA9IGF3YWl0IHdhaXRGb3JSZXNwb25zZU9yRXJyb3IocmVxdWVzdCk7XG4gICAgICAgICAgICBpZiAocmVzcG9uc2UgJiYgcmVzcG9uc2VCb2R5Q29sbGVjdG9yKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UsXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlQm9keTogYXdhaXQgcmVzcG9uc2VCb2R5Q29sbGVjdG9yLmdldEJvZHlBc3luYygpLFxuICAgICAgICAgICAgICAgICAgICBlcnJvcjogbnVsbFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2U6IG51bGwsXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlQm9keTogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgZXJyb3JcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHJlc3BvbnNlQm9keUNvbGxlY3RvcicpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KSgpXG4gICAgXSk7XG5cbiAgICBjb25zdCBwcm90b2NvbCA9IChyZXF1ZXN0IGFzIENsaWVudFJlcXVlc3RXaXRoVW5kb2N1bWVudGVkTWVtYmVycykuYWdlbnRcbiAgICAgICAgLnByb3RvY29sO1xuICAgIGNvbnN0IGhvc3QgPSByZXF1ZXN0LmdldEhlYWRlcignaG9zdCcpO1xuICAgIGNvbnN0IHBhdGggPSByZXF1ZXN0LnBhdGg7XG5cbiAgICBjb25zdCBsb2dnZXJSZXF1ZXN0OiBMb2dnZXJSZXF1ZXN0ID0ge1xuICAgICAgICB1cmw6IGAke3Byb3RvY29sfS8vJHtob3N0fSR7cGF0aH1gLFxuICAgICAgICBtZXRob2Q6IChyZXF1ZXN0IGFzIENsaWVudFJlcXVlc3RXaXRoVW5kb2N1bWVudGVkTWVtYmVycykubWV0aG9kLFxuICAgICAgICBoZWFkZXJzOiAocmVxdWVzdCBhcyBDbGllbnRSZXF1ZXN0V2l0aFVuZG9jdW1lbnRlZE1lbWJlcnMpLl9oZWFkZXJzLFxuICAgICAgICBib2R5OiByZXF1ZXN0Qm9keSA/IHJlcXVlc3RCb2R5IDogbnVsbFxuICAgIH07XG4gICAgaWYgKHJlc3BvbnNlKSB7XG4gICAgICAgIGNvbnN0IGxvZ2dlclJlc3BvbnNlOiBMb2dnZXJSZXNwb25zZSA9IHtcbiAgICAgICAgICAgIHN0YXR1czogcmVzcG9uc2Uuc3RhdHVzQ29kZSxcbiAgICAgICAgICAgIGJvZHk6IHJlc3BvbnNlQm9keSA/IHJlc3BvbnNlQm9keSA6IG51bGwsXG4gICAgICAgICAgICBoZWFkZXJzOiAocmVzcG9uc2UgYXMgU2VydmVyUmVzcG9uc2VXaXRoVW5kb2N1bWVudGVkTWVtYmVycylcbiAgICAgICAgICAgICAgICAuaGVhZGVycyBhcyBMb2dnZXJIZWFkZXJzXG4gICAgICAgIH07XG4gICAgICAgIG9uUmVxdWVzdEVuZCh7XG4gICAgICAgICAgICByZXF1ZXN0OiBsb2dnZXJSZXF1ZXN0LFxuICAgICAgICAgICAgcmVzcG9uc2U6IGxvZ2dlclJlc3BvbnNlLFxuICAgICAgICAgICAgZXJyb3I6IG51bGxcbiAgICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChlcnJvcikge1xuICAgICAgICBjb25zdCBsb2dnZXJFcnJvciA9IHtcbiAgICAgICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsXG4gICAgICAgICAgICBjb2RlOiAoZXJyb3IgYXMgYW55KS5jb2RlIGFzIHN0cmluZyxcbiAgICAgICAgICAgIHN0YWNrOiBlcnJvci5zdGFjayB8fCAnJ1xuICAgICAgICB9O1xuICAgICAgICBvblJlcXVlc3RFbmQoe1xuICAgICAgICAgICAgcmVxdWVzdDogbG9nZ2VyUmVxdWVzdCxcbiAgICAgICAgICAgIHJlc3BvbnNlOiBudWxsLFxuICAgICAgICAgICAgZXJyb3I6IGxvZ2dlckVycm9yXG4gICAgICAgIH0pO1xuICAgIH1cbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEdsb2JhbEh0dHBMb2dnZXIge1xuICAgIG9uUmVxdWVzdEVuZDogTG9nZ2VyT25SZXNwb25zZUNhbGxiYWNrO1xuICAgIGNvbnN0cnVjdG9yKHsgb25SZXF1ZXN0RW5kIH06IHsgb25SZXF1ZXN0RW5kOiBMb2dnZXJPblJlc3BvbnNlQ2FsbGJhY2sgfSkge1xuICAgICAgICB0aGlzLm9uUmVxdWVzdEVuZCA9IG9uUmVxdWVzdEVuZDtcbiAgICB9XG4gICAgc3RhcnQoKSB7XG4gICAgICAgIGNvbnN0IHsgb25SZXF1ZXN0RW5kIH0gPSB0aGlzO1xuICAgICAgICBjb25zdCBpbnRlcmNlcHRlZFJlcXVlc3RNZXRob2QgPSAoXG4gICAgICAgICAgICBvYmplY3Q6IGFueSxcbiAgICAgICAgICAgIGZ1bmM6IGFueSxcbiAgICAgICAgICAgIC4uLnJlc3Q6IGFueVxuICAgICAgICApID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlcSA9IGZ1bmMuY2FsbChvYmplY3QsIC4uLnJlc3QpO1xuICAgICAgICAgICAgaW50ZXJjZXB0UmVxdWVzdChyZXEsIHsgb25SZXF1ZXN0RW5kIH0pO1xuICAgICAgICAgICAgcmV0dXJuIHJlcTtcbiAgICAgICAgfTtcblxuICAgICAgICBodHRwLnJlcXVlc3QgPSBpbnRlcmNlcHRlZFJlcXVlc3RNZXRob2QuYmluZChudWxsLCBodHRwLCBodHRwLnJlcXVlc3QpO1xuICAgICAgICBodHRwLmdldCA9IGludGVyY2VwdGVkUmVxdWVzdE1ldGhvZC5iaW5kKG51bGwsIGh0dHAsIGh0dHAuZ2V0KTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogaHR0cHMucmVxdWVzdCBwcm94aWVzIHRvIGh0dHAucmVxdWVzdCBmb3IgOC54IGFuZCBlYXJsaWVyIHZlcnNpb25zXG4gICAgICAgICAqL1xuICAgICAgICBpZiAobm9kZU1ham9yVmVyc2lvbiA+IDgpIHtcbiAgICAgICAgICAgIGh0dHBzLmdldCA9IGludGVyY2VwdGVkUmVxdWVzdE1ldGhvZC5iaW5kKG51bGwsIGh0dHBzLCBodHRwcy5nZXQpO1xuICAgICAgICAgICAgaHR0cHMucmVxdWVzdCA9IGludGVyY2VwdGVkUmVxdWVzdE1ldGhvZC5iaW5kKFxuICAgICAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICAgICAgaHR0cHMsXG4gICAgICAgICAgICAgICAgaHR0cHMucmVxdWVzdFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBzdG9wKCkge31cbn1cbiJdfQ==